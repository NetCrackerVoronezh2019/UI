<body>
  <app-navbar></app-navbar>
  <div class="menu" [ngStyle]="{'right' :sidebarVisible ? '220px' : '0'}">
          <div class="back" routerLink="/dialogsList"><i class="fa fa-chevron-left"></i>  <img *ngIf="dialog?.image==null" src='https://www.egalochkina.ru/wp-content/uploads/2018/03/dialog-sokrata.jpg'/>
            <img *ngIf="dialog?.image==null && dialog?.type!='private'" src='https://www.egalochkina.ru/wp-content/uploads/2018/03/dialog-sokrata.jpg'/>
            <img *ngIf="loading"  [src]="dialogImage"/>
            <img *ngIf="dialog?.type == 'private' && anUser?.image == null" src='https://dontshake.org/media/k2/items/cache/71f67488b0857639cee631943a3fc6fa_XL.jpg'/></div>
        <div class="name">{{name}}</div>
      <div class="last">{{date}}</div>
      <div class="settings" (click)="sidebarOpen()">
        <i class="fa fa-cog" aria-hidden="true"></i>
      </div>
  </div>
  <ol class="chat" #scrollMe [scrollTop]="scrollMe.scrollHeight" [ngStyle]="{'right' :sidebarVisible ? '220px' : '0'}">
    <ul *ngFor ='let message of messages'>
        <app-message-card [(type)]="dialog.type" [(message)]="message" (imageClick)="openImage($event)" [(mymessage)]="message.sender.userId == user.userId" (setMessage)="startSetMessage($event)" (addAdvertismentFiles)="addAttachmentsFromDialog($event)"></app-message-card>
  </ul>
  </ol>
  <div id="Sending" [ngStyle]="{'right' :sidebarVisible ? '220px' : '0'}">
    <form class="mt-5" [formGroup]="dgService.getMessageForm()">
          <input id="message" maxlength="255" placeholder="Write your message" type="text" class="form-control textarea" formControlName="text" [(ngModel)]="textbox"/>
          <div *ngIf="!isSet">
          <button class="btn btn-light btn-primary-spacing" (click)="sendMessage()">Отправить</button>
          <div class="example-2">
                <input type="file" name="file" id="file"  (change)="handleFileMessageInput($event.target.files)"  multiple accept="image/*, application/pdf" class="input-file"/>
                <label for="file" class="btn btn-tertiary js-labelFile">
                  <i class="icon fa fa-check"></i>
                  <span class="js-fileName"> Загрузить Файлы</span>
                </label>
          </div>
          <div class="mb-3 file" *ngFor="let not of allNames; let i = index" (click)="deleteImageFromList(i)">
              <span  matBadge="x"  matBadgeOverlap="false" >{{not}}</span>
           </div>
        </div>
        <div *ngIf="isSet">
            <button class="btn btn-light btn-primary-spacing" (click)="setMessage()">Изменить</button>
            <button class="btn btn-light btn-primary-spacing" (click)="closeSetMessage()">Отмена</button>
        </div>
    </form>
  </div>
  <div *ngIf="sidebarVisible" id="sidebar">
    <div *ngIf="!userSearchPanelVisible && !settingsVisible">
    <button mat-raised-button class="ml-2" *ngIf="dialog?.type=='public'" (click)="openUserAddForm()"><i class="fas fa-plus-circle"></i>Добавить пользователя</button>
    <button mat-raised-button class="ml-2" *ngIf="dialog?.type=='public'" (click)="liveDialog()"><i class="fas fa-minus-circle"></i>Покинуть диалог</button>
    <div *ngIf="dialog?.creatorId == user?.userId">
      <button mat-raised-button class="ml-2" *ngIf="dialog?.type=='public'" (click)="deleteDialog()"><i class="fas fa-minus-circle"></i>Удалить диалог</button>
      <button mat-raised-button class="ml-2" *ngIf="dialog?.type=='public'" (click)="showSettings()"><i class="fas fa-minus-circle"></i>Настройки</button>
    </div>
    Участники:
    <div *ngFor ='let user of dialogMembers'>
      <app-dialog-member-card [(us)]="user"></app-dialog-member-card>
    </div>
    </div>
    <div *ngIf="settingsVisible">
      <h3>Настройки чата</h3>
      <form [formGroup]="dgService.getDialogSettingsForm()">
          <div class="form-group">
            <label for="">Имя чата</label>
            <input id="Name" type="text" class="form-control" formControlName="name" autocomplete="off" placeholder="Dialog name">
            <div *ngIf="dgService.getDialogSettingsForm().controls['name'].invalid && dgService.getDialogSettingsForm().controls['name'].touched" >
              <small  *ngIf="dgService.getDialogSettingsForm().controls['name'].errors.minlength">Имя слишком короткое</small>
              <small  *ngIf="dgService.getDialogSettingsForm().controls['name'].errors.maxlength">Имя слишком длинное</small>
            </div>
          </div>
      </form>
      <button mat-raised-button class="ml-2" (click)="acceptSettings()"><i class="fas fa-check-circle"></i>Изменить</button>
      <button mat-raised-button class="ml-2" (click)="closeSetings()"><i class="fas fa-minus-circle"></i>Закрыть</button>
      <div class="example-2">
            <input type="file" name="file" id="fil"  (change)="handleFileInput($event.target.files)"  multiple accept="image/*" class="input-file"/>
            <label for="file" class="btn btn-tertiary js-labelFile">
              <i class="icon fa fa-check"></i>
              <span class="js-fileName"> Загрузить Аватар</span>
            </label>
      </div>
      <span class="mb-3"  matBadgeOverlap="false" >{{fileName}}</span>
      <label for="file" class="btn btn-tertiary js-labelFile">
        <button class="js-fileName" *ngIf="avatar!=undefined" (click)="setAvatar()"><i class="icon fa fa-check"></i> Изменить Аватар</button>
      </label>
      </div>
    <div *ngIf="userSearchPanelVisible">
      <form [formGroup]="dgService.getUserSearchForm()">
        <h5>Поиск</h5>
        <label for="">Имя</label>
        <input type="text" class="form-control" formControlName="firstName" autocomplete="off" placeholder="Имя">
        <div *ngIf="dgService.getUserSearchForm().controls['firstName'].invalid && dgService.getUserSearchForm().controls['firstName'].touched" >
          <small  *ngIf="dgService.getUserSearchForm().controls['firstName'].errors.minlength">Имя слишком короткое</small>
          <small  *ngIf="dgService.getUserSearchForm().controls['firstName'].errors.maxlength">Имя слишком длинное</small>
        </div>
        <label for="">Фамилия</label>
        <input type="text" class="form-control" formControlName="lastName" autocomplete="off" placeholder="Фамилия">
        <div *ngIf="dgService.getUserSearchForm().controls['lastName'].invalid && dgService.getUserSearchForm().controls['lastName'].touched" >
          <small  *ngIf="dgService.getUserSearchForm().controls['lastName'].errors.minlength">Имя слишком короткое</small>
          <small  *ngIf="dgService.getUserSearchForm().controls['lastName'].errors.maxlength">Имя слишком длинное</small>
        </div>
      </form>
      <button mat-raised-button class="ml-2" (click)="search()"><i class="fas fa-search"></i>Поиск</button>
      <button mat-raised-button class="ml-2" (click)="closeUserAddForm()"><i class="fas fa-minus-circle"></i>Отмена</button>
    <div *ngFor ='let us of users' align="center">
      <app-user-card [(us)]="us" *ngIf="user.userId != us.userId" (click)="invite(us)"></app-user-card>
    </div>
   </div>
  </div>
  <div *ngIf="fullImage!=null" class="fullImage">
    <img [src]="fullImage" (click)="closeImage()">
  </div>
</body>
